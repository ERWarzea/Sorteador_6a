<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Sorteador - 6¬™ & Categoria - V1.3.4</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; font-size: 1.6em; }
    textarea { width: 100%; height: 500px; margin-bottom: 10px; font-size: 1em; }
    .player-list { margin: 10px 0; }
    .player-list label, #presenceForm label { display: block; margin-bottom: 5px; white-space: pre-line; }
    .hidden { display: none; }
    .team { margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    .red { color: red; font-weight: bold; }
    .footer { margin-top: 30px; text-align: center; font-size: 0.9em; color: #666; }
    button.copy-btn { margin-top: 20px; padding: 10px 20px; font-size: 1em; cursor: pointer; }
    .joke-flag { font-size: 0.8em; color: #666; }
  </style>
</head>
<body>
  <h1>6¬∞ Ano de Futs - ü•©üçªüèÜ</h1>

  <label for="playersInput">Cole aqui a lista de nomes (direto do WhatsApp):</label>
  <textarea id="playersInput"></textarea>
  <button onclick="processList()">Confirmar Lista</button>

  <div id="presenceSection" class="hidden">
    <h2>‚úÖ Marque quem est√° presente</h2>
    <form id="presenceForm" class="player-list"></form>

    <br>
    <label for="goalies">Quantos goleiros dispon√≠veis?</label>
    <select id="goalies">
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
    <br><br>
    <label><input type="checkbox" id="includeAbsents"> Incluir ausentes no sorteio</label>
    <br><br>
    <label class="joke-flag"><input type="checkbox" checked disabled>Sempre colocar o Eli√£o no melhor time</label>
    <br><br>
    <button onclick="drawTeams(event)">Sortear Times</button>
  </div>

  <div id="results" class="hidden">
    <h2>üé¥ Resultado do Sorteio</h2>
    <div id="teamsOutput"></div>
    <button class="copy-btn" onclick="copyToClipboard()">üìã Copiar resultado</button>
  </div>

  <div class="footer">
    <p>ü§ñ C√≥digo desenvolvido com ajuda do ChatGPT ¬∑ OpenAI</p>
  </div>

  <script>
    const suits = ['‚ô£', '‚ô•', '‚ô†', '‚ô¶'];

    function processList() {
      const input = document.getElementById('playersInput').value;
      const cleanBlock = extractConfirmedPlayers(input);
      const names = cleanBlock.filter(name => name && name.trim().length > 0);

      const form = document.getElementById('presenceForm');
      form.innerHTML = '';

      names.forEach((name, i) => {
        const id = 'player_' + i;
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.value = name;
        checkbox.checked = true;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + name));
        form.appendChild(label);
      });

      document.getElementById('presenceSection').classList.remove('hidden');
    }

    function extractConfirmedPlayers(text) {
      const lowerText = text.toLowerCase();
      const start = lowerText.indexOf('confirmados');
      if (start === -1) return [];

      const enders = ['falta confirmar', 'fora', 'dm'];
      let end = lowerText.length;
      for (const word of enders) {
        const idx = lowerText.indexOf(word);
        if (idx > start && idx < end) end = idx;
      }

      const content = text.substring(start, end).replace(/confirmados[\s\n:]*/i, '');
      const lines = content
        .split(/\n|\r|\d+\.|\d+\)/)
        .map(line => line.trim())
        .filter(line =>
          line &&
          !/^\d+$/.test(line) &&
          !/^confirmados$/i.test(line) &&
          !line.startsWith('#')
        );

      const unique = [];
      const seen = new Set();
      for (const line of lines) {
        const cleanLine = line.trim();
        if (!seen.has(cleanLine)) {
          seen.add(cleanLine);
          unique.push(cleanLine);
        }
      }

      return unique;
    }

    function classifyPlayer(name) {
      const stars = (name.match(/\*/g) || []).length;
      return stars > 3 ? 3 : stars;
    }

    function displayStars(name) {
      const starCount = (name.match(/\*/g) || []).length;
      return name.replace(/\*+/g, '').trim() + ' ' + '‚≠ê'.repeat(Math.min(starCount, 3));
    }

    function drawTeams(e) {
      e.preventDefault();

      const allCheckboxes = document.querySelectorAll('#presenceForm input');
      const includeAbsents = document.getElementById('includeAbsents').checked;
      const goalieCount = parseInt(document.getElementById('goalies').value);

      const presentPlayers = [];
      const absentPlayers = [];

      allCheckboxes.forEach(cb => {
        if (cb.checked) presentPlayers.push(cb.value);
        else if (includeAbsents) absentPlayers.push(cb.value);
      });

      let playersPool = [...presentPlayers];
      if (includeAbsents) playersPool = playersPool.concat(absentPlayers);

      if (playersPool.length > 20) {
        alert("M√°ximo de 20 jogadores!");
        return;
      }

      const totalPlayers = playersPool.length;
      const totalTeams = Math.ceil(totalPlayers / 5);
      const teams = Array.from({ length: totalTeams }, () => []);
      const used = new Set();

      const presenceMap = {};
      presentPlayers.forEach(p => presenceMap[p] = true);
      absentPlayers.forEach(p => presenceMap[p] = false);

      const byLevel = { 3: [], 2: [], 1: [], 0: [] };
      for (const p of playersPool) {
        const level = classifyPlayer(p);
        byLevel[level].push(p);
      }

      for (let level = 3; level >= 0; level--) {
        const group = shuffle(byLevel[level]);
        const presentGroup = group.filter(p => presenceMap[p]);
        const absentGroup = group.filter(p => !presenceMap[p]);

        const sortedGroup = presentGroup.concat(absentGroup);

        let teamIndex = 0;
        for (const p of sortedGroup) {
          let placed = false;
          let attempts = 0;
          while (!placed && attempts < totalTeams) {
            const team = teams[teamIndex];
            const hasSameLevel = team.some(tp => classifyPlayer(tp) === level);
            if (team.length < 5 && !hasSameLevel) {
              team.push(p);
              used.add(p);
              placed = true;
            }
            teamIndex = (teamIndex + 1) % totalTeams;
            attempts++;
          }
          if (!placed) {
            for (let t of teams) {
              if (t.length < 5) {
                t.push(p);
                used.add(p);
                break;
              }
            }
          }
        }
      }

      const output = document.getElementById('teamsOutput');
      output.innerHTML = '';

      teams.forEach((team, i) => {
        const icon = suits[i] || '';
        const title = `Time ${i + 1} (${icon} ${['Paus', 'Copas', 'Espadas', 'Ouros'][i] || ''})`;
        const className = i % 2 === 1 ? 'team red' : 'team';
        output.innerHTML += `
          <div class="${className}">
            <strong>${title}</strong><br>
            ${team.map(p => `- ${displayStars(p)}`).join('<br>')}
          </div>`;
      });

      output.innerHTML += `<div class="team">
        <h3>üìã Regras Especiais</h3>
        <ul>
          <li>Time 1 (‚ô£) escolhe o ${goalieCount >= 1 ? 'primeiro' : ''} goleiro</li>
          ${goalieCount === 3 ? '<li class="red">Time 2 (‚ô•) escolhe o segundo goleiro</li>' : '<li class="red">Time 2 (‚ô•) fica com o outro goleiro</li>'}
          <li class="red">Time 2 (‚ô•) come√ßa com a bola</li>
          <li>Time 3 (‚ô†) √© o primeiro pr√≥ximo</li>
          <li class="red">Time 4 (‚ô¶) √© o segundo pr√≥ximo (entra no 3¬∫ jogo, exceto em caso de empate)</li>
        </ul>
      </div>`;

      document.getElementById('results').classList.remove('hidden');
    }

    function shuffle(arr) {
      let a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function copyToClipboard() {
      const output = document.getElementById('teamsOutput');
      const temp = document.createElement('textarea');
      const html = output.innerHTML
        .replace(/<br>/g, '\n')
        .replace(/<[^>]+>/g, '')
        .replace(/&nbsp;/g, ' ')
        .replace(/&amp;/g, '&');
      temp.value = html.trim();
      document.body.appendChild(temp);
      temp.select();
      document.execCommand('copy');
      document.body.removeChild(temp);
      alert('Resultado copiado para a √°rea de transfer√™ncia!');
    }
  </script>
</body>
</html>
